name: Post mini-app button to Telegram

on:
  workflow_dispatch: # –∑–∞–ø—É—Å–∫ —Ä—É–∫–∞–º–∏ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ Actions
    inputs:
      message:
        description: '–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞'
        required: false
        default: '–ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–Ω–∏-–∞–ø–ø üëá'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/post-miniapp.yml' # —É–±–µ—Ä–∏ –∏–ª–∏ –ø–æ–º–µ–Ω—è–π, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ—Å—Ç–∏—Ç—å –ø—Ä–∏ –ø—É—à–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      MINI_APP_URL: ${{ secrets.MINI_APP_URL }}
      # –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤–≤–æ–¥ –∏–∑ workflow_dispatch ‚Üí —Å–µ–∫—Ä–µ—Ç MESSAGE_TEXT ‚Üí –¥–µ—Ñ–æ–ª—Ç
      MESSAGE_TEXT: ${{ github.event.inputs.message || secrets.MESSAGE_TEXT || '–ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–Ω–∏-–∞–ø–ø üëá' }}
    steps:
      - name: Send message with web_app button
        run: |
          set -e

          # –°–æ–±–∏—Ä–∞–µ–º JSON —á–µ—Ä–µ–∑ jq, —á—Ç–æ–±—ã –Ω–µ –º—É—á–∏—Ç—å—Å—è —Å –∫–∞–≤—ã—á–∫–∞–º–∏
          sudo apt-get update -y
          sudo apt-get install -y jq

          PAYLOAD=$(jq -n \
            --arg chat_id "$CHANNEL" \
            --arg text "$MESSAGE_TEXT" \
            --arg url "$MINI_APP_URL" \
            '{
              chat_id: $chat_id,
              text: $text,
              reply_markup: {
                inline_keyboard: [[
                  { text: "–û—Ç–∫—Ä—ã—Ç—å mini-app", web_app: { url: $url } }
                ]]
              }
            }')

          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
          | jq .

      - name: Fail if Telegram returned an error
        run: |
          # –ø—Ä–æ—Å—Ç–æ–π —á–µ–∫ –Ω–∞ "ok": true
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
